<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNIMO BRIDGE</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { margin: 0; background: #000; color: #fff; font-family: monospace; overflow: hidden; }
        
        /* ðŸ”´ DEBUG BOX: Shows you EXACTLY what data exists */
        #debug-console {
            position: fixed; top: 0; left: 0; width: 100%; height: 30vh;
            background: rgba(50, 0, 0, 0.9); color: #0f0; padding: 10px;
            font-size: 12px; overflow-y: scroll; z-index: 9999;
            border-bottom: 2px solid red; display: block;
        }

        #map { height: 70vh; width: 100%; position: absolute; bottom: 0; }
        
        .floating-btn {
            position: fixed; bottom: 20px; left: 5%; width: 90%;
            padding: 15px; background: #2481cc; color: white; border: none;
            font-size: 16px; font-weight: bold; border-radius: 12px; z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="debug-console">Initializing Bridge...<br></div>
    
    <div id="map"></div>
    <button id="confirmBtn" class="floating-btn" onclick="sendHandshake()" disabled>WAITING...</button>

    <script>
        // 1. LOGGER FUNCTION
        function log(msg) {
            const box = document.getElementById('debug-console');
            box.innerHTML += `> ${msg}<br>`;
            console.log(msg);
        }

        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        // ðŸ›‘ PASTE KEYS HERE
        const SB_URL = 'https://zvoywylatpccjpwvrrhz.supabase.co'; 
        const SB_KEY = 'sb_publishable_aRnVwfxmtkKa1mrt35osew_KFRqZ_2v'; // <--- PASTE REAL KEY
        const NGROK_URL = 'https://gloomiest-preinstructional-cinderella.ngrok-free.dev';

        async function init() {
            try {
                log("ðŸš€ Starting App...");

                // 2. THE CRITICAL BRIDGE: Read Telegram Data
                // Telegram holds the data in 'initDataUnsafe', NOT in the URL.
                const telegramData = tg.initDataUnsafe;
                
                log(`ðŸ“± Telegram Param: ${telegramData.start_param || "NONE"}`);
                
                let token = null;

                // SCENARIO A: Inside Telegram
                if (telegramData.start_param) {
                    log("âœ… Found Telegram Data!");
                    // Remove "offer_" prefix to get pure UUID
                    token = telegramData.start_param.replace('offer_', '');
                } 
                // SCENARIO B: Browser Testing (Fallback)
                else {
                    const urlParams = new URLSearchParams(window.location.search);
                    token = urlParams.get('token');
                    log(`ðŸŒ Browser URL Param: ${token || "NONE"}`);
                }

                if (!token) {
                    log("âŒ FATAL: No Token found in Telegram OR Browser.");
                    throw new Error("EMPTY_DATA");
                }

                log(`ðŸ”‘ Decoded Token: ${token}`);
                
                // 3. DATABASE FETCH
                if (SB_KEY.includes('YOUR_ACTUAL')) throw new Error("âš ï¸ KEY NOT SET!");
                const db = supabase.createClient(SB_URL, SB_KEY);
                
                log("ðŸ“¡ Querying Database...");
                const { data, error } = await db.rpc('get_public_ride_info', { token_input: token });

                if (error) throw new Error(error.message);
                if (!data || data.length === 0) throw new Error("Ride ID invalid/expired");

                const ride = data[0];
                log(`âœ… DATA RECEIVED: ${ride.p_name} -> ${ride.d_name}`);

                // 4. ACTIVATE UI
                document.getElementById('confirmBtn').innerText = `âœ… CONFIRM: ${ride.p_name}`;
                document.getElementById('confirmBtn').disabled = false;
                document.getElementById('debug-console').style.display = 'none'; // Hide debug if success

                // 5. MAP
                const map = L.map('map', { zoomControl: false }).setView([ride.p_lat, ride.p_lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                
                L.Routing.control({
                    waypoints: [L.latLng(ride.p_lat, ride.p_lng), L.latLng(ride.d_lat, ride.d_lng)],
                    lineOptions: { styles: [{ color: '#2481cc', weight: 6 }] },
                    show: false, createMarker: () => null
                }).addTo(map);

            } catch (e) {
                log(`ðŸ›‘ CRASH: ${e.message}`);
                alert("SYSTEM ERROR: " + e.message);
            }
        }

        async function sendHandshake() {
            try {
                // We send the RAW param from Telegram (e.g., "offer_UUID") back to Python
                // Python expects "offer_" to be there!
                const rawParam = tg.initDataUnsafe.start_param || ("offer_" + new URLSearchParams(window.location.search).get('token'));
                
                await fetch(`${NGROK_URL}/app-trigger`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        _auth: tg.initData, 
                        ride_id: rawParam 
                    })
                });
                tg.close();
            } catch (e) {
                alert("Bot Connect Error: " + e.message);
            }
        }

        init();
    </script>
</body>
</html>
